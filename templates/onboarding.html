<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - Hotel Recommendations</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .onboarding-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 40px auto;
            max-width: 800px;
            overflow: hidden;
        }
        
        .progress-bar-container {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .step-content {
            padding: 40px;
            min-height: 500px;
        }
        
        .preference-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .preference-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .preference-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .preference-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .btn-outline-primary {
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            color: #667eea;
        }
        
        .range-slider {
            width: 100%;
            margin: 20px 0;
        }
        
        .range-value {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="onboarding-container">
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Welcome! Let's personalize your experience</h4>
                    <span class="badge bg-primary" id="stepIndicator">Step 1 of 5</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="step-content">
                <!-- Step 1: Travel Purpose -->
                <div id="step1" class="step-container">
                    <h2 class="text-center mb-4">What's your primary travel purpose?</h2>
                    <p class="text-center text-muted mb-4">This helps us recommend hotels that match your travel style</p>
                    
                    <div class="row" id="travelPurposeOptions">
                        <div class="col-md-4">
                            <div class="preference-card" data-value="business">
                                <div class="preference-icon">üíº</div>
                                <h5>Business</h5>
                                <p class="small text-muted">Work trips, conferences, meetings</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="leisure">
                                <div class="preference-icon">üèñÔ∏è</div>
                                <h5>Leisure</h5>
                                <p class="small text-muted">Vacation, relaxation, sightseeing</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="family">
                                <div class="preference-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                                <h5>Family</h5>
                                <p class="small text-muted">Family trips, kids-friendly places</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="romantic">
                                <div class="preference-icon">üíï</div>
                                <h5>Romantic</h5>
                                <p class="small text-muted">Couples getaway, honeymoon</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="adventure">
                                <div class="preference-icon">üèîÔ∏è</div>
                                <h5>Adventure</h5>
                                <p class="small text-muted">Outdoor activities, exploration</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="wellness">
                                <div class="preference-icon">üßò</div>
                                <h5>Wellness</h5>
                                <p class="small text-muted">Spa, health, relaxation</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Budget Range -->
                <div id="step2" class="step-container d-none">
                    <h2 class="text-center mb-4">What's your typical budget range?</h2>
                    <p class="text-center text-muted mb-4">Per night, per room in USD</p>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <label class="form-label">Budget Range: $<span id="budgetMin">50</span> - $<span id="budgetMax">300</span> per night</label>
                                <div class="d-flex align-items-center">
                                    <span class="me-3">$50</span>
                                    <input type="range" class="form-range flex-grow-1" id="budgetRange" min="50" max="1000" value="300">
                                    <span class="ms-3">$1000+</span>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="preference-card" data-value="budget">
                                        <div class="preference-icon">üí∞</div>
                                        <h5>Budget-Friendly</h5>
                                        <p class="small text-muted">$50-$150 per night</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="preference-card" data-value="mid-range">
                                        <div class="preference-icon">üè®</div>
                                        <h5>Mid-Range</h5>
                                        <p class="small text-muted">$150-$400 per night</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="preference-card" data-value="luxury">
                                        <div class="preference-icon">‚ú®</div>
                                        <h5>Luxury</h5>
                                        <p class="small text-muted">$400-$800 per night</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="preference-card" data-value="ultra-luxury">
                                        <div class="preference-icon">üëë</div>
                                        <h5>Ultra-Luxury</h5>
                                        <p class="small text-muted">$800+ per night</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Hotel Amenities -->
                <div id="step3" class="step-container d-none">
                    <h2 class="text-center mb-4">Which amenities are important to you?</h2>
                    <p class="text-center text-muted mb-4">Select all that apply</p>
                    
                    <div class="row" id="amenitiesOptions">
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="wifi">
                                <div class="preference-icon">üì∂</div>
                                <h6>Free WiFi</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="pool">
                                <div class="preference-icon">üèä</div>
                                <h6>Swimming Pool</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="gym">
                                <div class="preference-icon">üèãÔ∏è</div>
                                <h6>Fitness Center</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="spa">
                                <div class="preference-icon">üíÜ</div>
                                <h6>Spa Services</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="restaurant">
                                <div class="preference-icon">üçΩÔ∏è</div>
                                <h6>Restaurant</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="parking">
                                <div class="preference-icon">üöó</div>
                                <h6>Parking</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="pet-friendly">
                                <div class="preference-icon">üêï</div>
                                <h6>Pet Friendly</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="business-center">
                                <div class="preference-icon">üíª</div>
                                <h6>Business Center</h6>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Location Preferences -->
                <div id="step4" class="step-container d-none">
                    <h2 class="text-center mb-4">Where do you prefer to stay?</h2>
                    <p class="text-center text-muted mb-4">Choose your preferred location types</p>
                    
                    <div class="row" id="locationOptions">
                        <div class="col-md-4">
                            <div class="preference-card" data-value="city-center">
                                <div class="preference-icon">üèôÔ∏è</div>
                                <h5>City Center</h5>
                                <p class="small text-muted">Downtown, business district</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="beach">
                                <div class="preference-icon">üèñÔ∏è</div>
                                <h5>Beachfront</h5>
                                <p class="small text-muted">Ocean view, beach access</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="airport">
                                <div class="preference-icon">‚úàÔ∏è</div>
                                <h5>Near Airport</h5>
                                <p class="small text-muted">Convenient for flights</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="tourist-area">
                                <div class="preference-icon">üó∫Ô∏è</div>
                                <h5>Tourist Area</h5>
                                <p class="small text-muted">Near attractions, shopping</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="quiet">
                                <div class="preference-icon">üåø</div>
                                <h5>Quiet Area</h5>
                                <p class="small text-muted">Peaceful, residential</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preference-card" data-value="transport">
                                <div class="preference-icon">üöá</div>
                                <h5>Public Transport</h5>
                                <p class="small text-muted">Metro, bus stations nearby</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Review Preferences -->
                <div id="step5" class="step-container d-none">
                    <h2 class="text-center mb-4">What matters most in reviews?</h2>
                    <p class="text-center text-muted mb-4">Help us understand what review aspects you value</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="form-label">Minimum Rating Preference</label>
                                <div class="d-flex align-items-center">
                                    <span class="me-3">3.0</span>
                                    <input type="range" class="form-range flex-grow-1" id="ratingRange" min="3" max="5" step="0.1" value="4.0">
                                    <span class="ms-3">5.0</span>
                                </div>
                                <div class="text-center mt-2">
                                    <span class="range-value" id="ratingValue">4.0 ‚≠ê</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="form-label">Minimum Number of Reviews</label>
                                <div class="d-flex align-items-center">
                                    <span class="me-3">10</span>
                                    <input type="range" class="form-range flex-grow-1" id="reviewCountRange" min="10" max="1000" value="100">
                                    <span class="ms-3">1000+</span>
                                </div>
                                <div class="text-center mt-2">
                                    <span class="range-value" id="reviewCountValue">100 reviews</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4" id="reviewAspectsOptions">
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="cleanliness">
                                <div class="preference-icon">üßΩ</div>
                                <h6>Cleanliness</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="service">
                                <div class="preference-icon">ü§ù</div>
                                <h6>Service Quality</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="location">
                                <div class="preference-icon">üìç</div>
                                <h6>Location</h6>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="preference-card" data-value="value">
                                <div class="preference-icon">üíé</div>
                                <h6>Value for Money</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="p-4 border-top">
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-primary" id="prevBtn" disabled>
                        ‚Üê Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Next ‚Üí
                    </button>
                    <button type="button" class="btn btn-primary d-none" id="finishBtn">
                        Complete Setup ‚ú®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        class OnboardingApp {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 5;
                this.preferences = {
                    travel_purpose: [],
                    budget_range: 300,
                    budget_category: [],
                    amenities: [],
                    location_preferences: [],
                    min_rating: 4.0,
                    min_reviews: 100,
                    review_aspects: []
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateProgress();
            }

            setupEventListeners() {
                // Preference card selection
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.preference-card')) {
                        this.handlePreferenceSelection(e.target.closest('.preference-card'));
                    }
                });

                // Range sliders
                document.getElementById('budgetRange')?.addEventListener('input', (e) => {
                    this.preferences.budget_range = parseInt(e.target.value);
                    document.getElementById('budgetMax').textContent = e.target.value;
                });

                document.getElementById('ratingRange')?.addEventListener('input', (e) => {
                    this.preferences.min_rating = parseFloat(e.target.value);
                    document.getElementById('ratingValue').textContent = `${e.target.value} ‚≠ê`;
                });

                document.getElementById('reviewCountRange')?.addEventListener('input', (e) => {
                    this.preferences.min_reviews = parseInt(e.target.value);
                    document.getElementById('reviewCountValue').textContent = `${e.target.value} reviews`;
                });
            }

            handlePreferenceSelection(card) {
                const value = card.dataset.value;
                const step = this.currentStep;
                
                if (step === 1) {
                    // Single selection for travel purpose
                    document.querySelectorAll('#step1 .preference-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    this.preferences.travel_purpose = [value];
                } else if (step === 2) {
                    // Single selection for budget category
                    document.querySelectorAll('#step2 .preference-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    this.preferences.budget_category = [value];
                } else if (step === 3) {
                    // Multiple selection for amenities
                    card.classList.toggle('selected');
                    if (card.classList.contains('selected')) {
                        if (!this.preferences.amenities.includes(value)) {
                            this.preferences.amenities.push(value);
                        }
                    } else {
                        this.preferences.amenities = this.preferences.amenities.filter(a => a !== value);
                    }
                } else if (step === 4) {
                    // Multiple selection for location preferences
                    card.classList.toggle('selected');
                    if (card.classList.contains('selected')) {
                        if (!this.preferences.location_preferences.includes(value)) {
                            this.preferences.location_preferences.push(value);
                        }
                    } else {
                        this.preferences.location_preferences = this.preferences.location_preferences.filter(l => l !== value);
                    }
                } else if (step === 5) {
                    // Multiple selection for review aspects
                    card.classList.toggle('selected');
                    if (card.classList.contains('selected')) {
                        if (!this.preferences.review_aspects.includes(value)) {
                            this.preferences.review_aspects.push(value);
                        }
                    } else {
                        this.preferences.review_aspects = this.preferences.review_aspects.filter(r => r !== value);
                    }
                }
            }

            nextStep() {
                if (this.validateCurrentStep()) {
                    if (this.currentStep < this.totalSteps) {
                        this.currentStep++;
                        this.showStep(this.currentStep);
                        this.updateProgress();
                    }
                }
            }

            previousStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.showStep(this.currentStep);
                    this.updateProgress();
                }
            }

            showStep(step) {
                // Hide all steps
                for (let i = 1; i <= this.totalSteps; i++) {
                    document.getElementById(`step${i}`).classList.add('d-none');
                }
                
                // Show current step
                document.getElementById(`step${step}`).classList.remove('d-none');
            }

            updateProgress() {
                const progress = (this.currentStep / this.totalSteps) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('stepIndicator').textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
                
                // Update navigation buttons
                document.getElementById('prevBtn').disabled = this.currentStep === 1;
                
                if (this.currentStep === this.totalSteps) {
                    document.getElementById('nextBtn').classList.add('d-none');
                    document.getElementById('finishBtn').classList.remove('d-none');
                } else {
                    document.getElementById('nextBtn').classList.remove('d-none');
                    document.getElementById('finishBtn').classList.add('d-none');
                }
            }

            validateCurrentStep() {
                switch (this.currentStep) {
                    case 1:
                        if (this.preferences.travel_purpose.length === 0) {
                            this.showAlert('Please select your primary travel purpose', 'warning');
                            return false;
                        }
                        break;
                    case 2:
                        if (this.preferences.budget_category.length === 0) {
                            this.showAlert('Please select your budget category', 'warning');
                            return false;
                        }
                        break;
                    case 3:
                        if (this.preferences.amenities.length === 0) {
                            this.showAlert('Please select at least one important amenity', 'warning');
                            return false;
                        }
                        break;
                    case 4:
                        if (this.preferences.location_preferences.length === 0) {
                            this.showAlert('Please select at least one location preference', 'warning');
                            return false;
                        }
                        break;
                    case 5:
                        if (this.preferences.review_aspects.length === 0) {
                            this.showAlert('Please select at least one important review aspect', 'warning');
                            return false;
                        }
                        break;
                }
                return true;
            }

            async finishOnboarding() {
                if (!this.validateCurrentStep()) {
                    return;
                }

                const finishBtn = document.getElementById('finishBtn');
                const originalText = finishBtn.innerHTML;
                
                try {
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        window.location.href = '/login';
                        return;
                    }

                    // Show loading state
                    finishBtn.disabled = true;
                    finishBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                    // Prepare preferences data according to the User model
                    const preferencesData = {
                        preferences: {
                            travel_purpose: Array.isArray(this.preferences.travel_purpose) ? this.preferences.travel_purpose : [],
                            budget_range: 300, // Default value from User model
                            budget_category: Array.isArray(this.preferences.budget_category) ? this.preferences.budget_category : [],
                            amenities: Array.isArray(this.preferences.amenities) ? this.preferences.amenities : [],
                            location_preferences: Array.isArray(this.preferences.location_preferences) ? this.preferences.location_preferences : [],
                            min_rating: parseFloat(this.preferences.minimum_rating) || 4.0, // Ensure it's a number
                            min_reviews: parseInt(this.preferences.minimum_reviews) || 50, // Ensure it's an integer
                            review_aspects: Array.isArray(this.preferences.review_aspects) ? this.preferences.review_aspects : [],
                            onboarding_completed: true
                        }
                    };

                    console.log('Sending preferences data:', preferencesData);
                    console.log('Using auth token:', authToken);
                    
                    const response = await fetch('/api/auth/complete-onboarding', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(preferencesData)
                    });

                    const responseData = await response.json().catch(() => ({}));
                    console.log('Server response:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: responseData
                    });

                    if (!response.ok) {
                        throw new Error(responseData.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // Update local storage with updated user data
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    currentUser.onboarding_complete = true;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    this.showAlert('Welcome! Your preferences have been saved. Redirecting to dashboard...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);

                } catch (error) {
                    console.error('Onboarding error:', error);
                    finishBtn.disabled = false;
                    finishBtn.innerHTML = originalText;
                    this.showAlert(error.message || 'Failed to save preferences. Please try again.', 'danger');
                }
            }

            showAlert(message, type = 'info') {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                         style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('afterbegin', alertHtml);
                
                setTimeout(() => {
                    const alert = document.querySelector('.alert');
                    if (alert) alert.remove();
                }, 5000);
            }
        }

        // Initialize onboarding app
        document.addEventListener('DOMContentLoaded', () => {
            const onboarding = new OnboardingApp();
            
            // Set up event listeners for navigation buttons
            document.getElementById('prevBtn').addEventListener('click', () => onboarding.previousStep());
            document.getElementById('nextBtn').addEventListener('click', () => onboarding.nextStep());
            document.getElementById('finishBtn').addEventListener('click', () => onboarding.finishOnboarding());
            
            // Set up event listeners for option selections
            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const input = this.querySelector('input[type="checkbox"], input[type="radio"]');
                    if (input) {
                        input.checked = !input.checked;
                    }
                });
            });
        });
    </script>
</body>
</html>
